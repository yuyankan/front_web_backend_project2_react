# ====== 阶段 1: 构建阶段 ======
FROM node:18-alpine AS builder

WORKDIR /app

# 1. 复制所有影响 npm ci 的文件 (利用 Docker 缓存)
#    - 只有当 package.json 或 lock 文件改变时，才重新执行 npm ci。
COPY package.json package-lock.json ./

# 2. 安装依赖
RUN npm ci

# 3. 复制所有影响 npm run build 配置的文件 (利用 Docker 缓存)
#    - 放在 npm ci 之后，可以避免在依赖不变时，因 vite.config.ts 变化而重新安装依赖。
#    - 如果您的 tsconfig.json/vite.config.ts 依赖于 node_modules 中的类型，
#      放在这里是合理的，但如果它们不依赖，可以移到 npm ci 之前。我们保留在这里。
COPY tsconfig*.json vite.config.ts ./

# 4. 复制所有源代码
#    - 排除 node_modules (通过 .dockerignore)
COPY . .

# 5. 执行构建
RUN npm run build    # 生成 dist 文件夹

# ====== 阶段 2: 生产阶段 (nginx) ======
# 保持不变，这是标准的生产环境阶段。
FROM my_nginx_image:202507

COPY --from=builder /app/dist /usr/share/nginx/html

# 删除默认配置文件（可选）
RUN rm -rf /etc/nginx/conf.d/*

# 拷贝我们自定义的 nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 8000
